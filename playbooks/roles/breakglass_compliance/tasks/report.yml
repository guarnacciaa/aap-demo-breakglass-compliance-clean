---
# Generate break-glass compliance report

- name: Build compliance summary
  set_fact:
    compliance_summary: >-
      {{
        compliance.checks
        | dict2items
        | selectattr('value.passed', 'equalto', false)
        | map(attribute='value.message')
        | list
      }}

- name: Write compliance report to file
  ansible.builtin.copy:
    dest: "{{ compliance_report_path | default('/tmp/breakglass_compliance_report.json') }}"
    content: >-
      {{
        {
          'hostname': inventory_hostname,
          'user': breakglass_username,
          'timestamp': ansible_date_time.iso8601,
          'checks': compliance.checks,
          'compliant': compliance.compliant,
          'summary': compliance_summary
        } | to_nice_json
      }}
    mode: "0644"
