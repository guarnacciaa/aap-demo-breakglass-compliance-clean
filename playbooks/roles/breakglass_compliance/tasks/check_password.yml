# ============================================================================
# PASSWORD EXPIRATION CHECK
# ============================================================================
# This task checks if the break-glass user's password is set to never expire.
#
# WHY THIS MATTERS:
# - An emergency account must ALWAYS be available
# - If the password expires, the account becomes unusable
# - Expired passwords can lock you out during an emergency
#
# EXPECTED: Password should NEVER expire
#
# ============================================================================

---
# Beginning of YAML document

- name: Get password max age
  # Get the password aging information for the user.

  command: "chage -l {{ breakglass_username }}"
  # "chage -l <username>" lists password aging information.
  # Example output:
  # Last password change                                    : Jan 15, 2025
  # Password expires                                        : never
  # Password inactive                                       : never
  # Account expires                                         : never
  # Minimum number of days between password change          : 0
  # Maximum number of days between password change          : -1
  # Number of days of warning before password expires       : 7
  #
  # The key line is "Password expires : never"

  register: chage
  # Save output to "chage" variable.
  # chage.stdout contains all the output text.

  changed_when: false
  # Read-only command.


- name: Check password expiration
  # Determine if the password is set to never expire.

  set_fact:
    password_ok: "{{ 'never' in chage.stdout | lower }}"
    # Check if the word "never" appears in the chage output.
    #
    # BREAKDOWN:
    # - "chage.stdout" - the full output text
    # - "| lower" - convert to lowercase (case-insensitive matching)
    # - "'never' in ..." - Python/Jinja2 "in" operator checks if substring exists
    #
    # If output contains "Password expires : never", this will be true.
    # If output contains "Password expires : Jan 15, 2026", this will be false.


- name: Record password policy check
  # Add the password check result to our compliance data structure.

  set_fact:
    compliance: >-
      {{
        compliance | combine({
          'checks': compliance.checks | combine({
            'password_expiry': {
              'passed': password_ok,
              'message': password_ok
                | ternary('Password never expires', 'Password expiration configured')
            }
          }),
          'compliant': compliance.compliant and password_ok
        })
      }}
    # Record whether password expiration is properly configured.
    #
    # PASS: password_ok=true, message="Password never expires"
    # FAIL: password_ok=false, message="Password expiration configured"
    #       (Having expiration configured is a FAILURE for an emergency account)
