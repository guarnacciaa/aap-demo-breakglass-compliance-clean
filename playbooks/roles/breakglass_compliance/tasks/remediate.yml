---
# Break-Glass Account Remediation Tasks

- name: Ensure break-glass primary group exists
  ansible.builtin.group:
    name: "{{ breakglass_username }}"
    gid: "{{ breakglass_gid | default(omit) }}"
    state: present

- name: Ensure break-glass user exists
  ansible.builtin.user:
    name: "{{ breakglass_username }}"
    uid: "{{ breakglass_uid | default(omit) }}"
    group: "{{ breakglass_username }}"
    groups: "{{ breakglass_groups | default([]) }}"
    shell: "{{ breakglass_shell }}"
    home: "{{ breakglass_home }}"
    comment: "{{ breakglass_comment }}"
    create_home: "{{ breakglass_create_home | bool }}"
    password: "{{ breakglass_password_hash | default(omit) }}"
    state: present
  register: breakglass_user_result

- name: Configure password aging policy
  ansible.builtin.command: >
    chage
    -M {{ breakglass_password_max_age }}
    -m {{ breakglass_password_min_age }}
    -W {{ breakglass_password_warn_age }}
    {{ breakglass_username }}
  changed_when: true
  when: breakglass_password_max_age is defined

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ breakglass_home }}/.ssh"
    state: directory
    owner: "{{ breakglass_username }}"
    group: "{{ breakglass_username }}"
    mode: "{{ breakglass_ssh_dir_mode }}"

- name: Configure SSH authorized key
  ansible.posix.authorized_key:
    user: "{{ breakglass_username }}"
    key: "{{ breakglass_ssh_pub_key }}"
    state: present
    exclusive: false
  when:
    - breakglass_ssh_pub_key is defined
    - breakglass_ssh_pub_key | length > 0

- name: Ensure authorized_keys permissions
  ansible.builtin.file:
    path: "{{ breakglass_home }}/.ssh/authorized_keys"
    owner: "{{ breakglass_username }}"
    group: "{{ breakglass_username }}"
    mode: "{{ breakglass_authorized_keys_mode }}"
  when:
    - breakglass_ssh_pub_key is defined
    - breakglass_ssh_pub_key | length > 0

- name: Ensure break-glass account is unlocked
  ansible.builtin.command: "passwd -u {{ breakglass_username }}"
  changed_when: true
  failed_when: false

- name: Ensure passwordless sudo for break-glass user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/breakglass
    line: "{{ breakglass_username }} ALL=(ALL) NOPASSWD: ALL"
    create: true
    mode: "0440"
    validate: "visudo -cf %s"
  when: breakglass_sudo_nopasswd | default(true)

- name: Display remediation summary
  ansible.builtin.debug:
    msg:
      remediation:
        host: "{{ inventory_hostname }}"
        user: "{{ breakglass_username }}"
        created_or_updated: "{{ breakglass_user_result.changed }}"
        home: "{{ breakglass_home }}"
        shell: "{{ breakglass_shell }}"
        groups: "{{ breakglass_groups }}"
        ssh_key_configured: "{{ breakglass_ssh_pub_key is defined }}"
        sudo_nopasswd: "{{ breakglass_sudo_nopasswd | default(true) }}"
