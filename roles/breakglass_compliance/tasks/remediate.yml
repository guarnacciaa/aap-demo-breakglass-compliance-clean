---
# Break-Glass Account Remediation Tasks

- name: Ensure break-glass group exists
  ansible.builtin.group:
    name: "{{ breakglass_username }}"
    gid: "{{ breakglass_gid | default(omit) }}"
    state: present

- name: Create break-glass user account
  ansible.builtin.user:
    name: "{{ breakglass_username }}"
    uid: "{{ breakglass_uid | default(omit) }}"
    group: "{{ breakglass_username }}"
    groups: "{{ breakglass_groups | default([]) }}"
    shell: "{{ breakglass_shell }}"
    home: "{{ breakglass_home }}"
    comment: "{{ breakglass_comment }}"
    create_home: "{{ breakglass_create_home | default(true) }}"
    password: "{{ breakglass_password_hash | default(omit) }}"
    state: present
  register: user_created

- name: Set password aging policy (never expire)
  ansible.builtin.command: >
    chage -M {{ breakglass_password_max_age }}
          -m {{ breakglass_password_min_age }}
          -W {{ breakglass_password_warn_age }}
          {{ breakglass_username }}
  changed_when: true
  when: breakglass_password_max_age == -1

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ breakglass_home }}/.ssh"
    state: directory
    owner: "{{ breakglass_username }}"
    group: "{{ breakglass_username }}"
    mode: "{{ breakglass_ssh_dir_mode }}"

- name: Configure SSH authorized keys
  ansible.posix.authorized_key:
    user: "{{ breakglass_username }}"
    key: "{{ breakglass_ssh_pub_key }}"
    state: present
    exclusive: false
  when: breakglass_ssh_pub_key is defined and breakglass_ssh_pub_key | length > 0

- name: Ensure authorized_keys file has correct permissions
  ansible.builtin.file:
    path: "{{ breakglass_home }}/.ssh/authorized_keys"
    owner: "{{ breakglass_username }}"
    group: "{{ breakglass_username }}"
    mode: "{{ breakglass_authorized_keys_mode }}"
  when: breakglass_ssh_pub_key is defined and breakglass_ssh_pub_key | length > 0

- name: Unlock the break-glass account
  ansible.builtin.command: passwd -u {{ breakglass_username }}
  changed_when: true
  failed_when: false
  when: user_created.changed

- name: Add break-glass user to sudoers (passwordless)
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/breakglass
    line: "{{ breakglass_username }} ALL=(ALL) NOPASSWD: ALL"
    create: true
    mode: "0440"
    validate: "visudo -cf %s"
  when: breakglass_sudo_nopasswd | default(true)

- name: Display remediation summary
  ansible.builtin.debug:
    msg: |
      ========================================
      BREAK-GLASS REMEDIATION COMPLETE
      ========================================
      Host: {{ inventory_hostname }}
      User: {{ breakglass_username }}
      UID: {{ breakglass_uid | default('auto') }}
      Home: {{ breakglass_home }}
      Shell: {{ breakglass_shell }}
      Groups: {{ breakglass_groups | join(', ') }}
      SSH Key: {{ 'Configured' if (breakglass_ssh_pub_key is defined and breakglass_ssh_pub_key | length > 0) else 'Not configured' }}
      Sudo: {{ 'Passwordless' if breakglass_sudo_nopasswd | default(true) else 'Standard' }}
      ========================================



