---
# Break-Glass Account Compliance Check Tasks

- name: Initialize compliance results
  ansible.builtin.set_fact:
    compliance_results:
      hostname: "{{ inventory_hostname }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      checks: {}
      compliant: true
      summary: []

# Check 1: Account existence
- name: Check if break-glass user exists
  ansible.builtin.getent:
    database: passwd
    key: "{{ breakglass_username }}"
  register: breakglass_user_check
  failed_when: false

- name: Record account existence check
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'checks': compliance_results.checks | combine({
            'account_exists': {
              'passed': breakglass_user_check.getent is defined and breakglass_user_check.getent != {},
              'message': 'User ' ~ breakglass_username ~ ' exists' if (breakglass_user_check.getent is defined and breakglass_user_check.getent != {}) else 'User ' ~ breakglass_username ~ ' does not exist'
            }
          })
        })
      }}

- name: Mark non-compliant if account missing
  ansible.builtin.set_fact:
    compliance_results: "{{ compliance_results | combine({'compliant': false}) }}"
  when: breakglass_user_check.getent is not defined or breakglass_user_check.getent == {}

# Check 2: UID validation (only if user exists)
- name: Get user UID
  ansible.builtin.shell: "id -u {{ breakglass_username }}"
  register: breakglass_uid_check
  changed_when: false
  failed_when: false
  when: breakglass_user_check.getent is defined and breakglass_user_check.getent != {}

- name: Record UID check
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'checks': compliance_results.checks | combine({
            'uid_valid': {
              'passed': ((breakglass_uid_check.stdout | int) >= breakglass_min_uid) and ((breakglass_uid_check.stdout | int) <= (breakglass_max_uid | default(65534))),
              'actual_uid': breakglass_uid_check.stdout | int,
              'message': 'UID ' ~ breakglass_uid_check.stdout ~ ' is within valid range' if ((breakglass_uid_check.stdout | int) >= breakglass_min_uid and (breakglass_uid_check.stdout | int) <= (breakglass_max_uid | default(65534))) else 'UID ' ~ breakglass_uid_check.stdout ~ ' is out of range (' ~ breakglass_min_uid ~ '-' ~ (breakglass_max_uid | default(65534)) ~ ')'
            }
          })
        })
      }}
  when: breakglass_uid_check.stdout is defined and breakglass_uid_check.stdout != ''

# Check 3: Shell validation
- name: Get user shell
  ansible.builtin.shell: "getent passwd {{ breakglass_username }} | cut -d: -f7"
  register: breakglass_shell_check
  changed_when: false
  failed_when: false
  when: breakglass_user_check.getent is defined and breakglass_user_check.getent != {}

- name: Record shell check
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'checks': compliance_results.checks | combine({
            'shell_valid': {
              'passed': breakglass_shell_check.stdout == breakglass_shell,
              'actual_shell': breakglass_shell_check.stdout,
              'expected_shell': breakglass_shell,
              'message': 'Shell is correctly set to ' ~ breakglass_shell if (breakglass_shell_check.stdout == breakglass_shell) else 'Shell mismatch: expected ' ~ breakglass_shell ~ ', got ' ~ breakglass_shell_check.stdout
            }
          })
        })
      }}
  when: breakglass_shell_check.stdout is defined

# Check 4: Home directory exists
- name: Check if home directory exists
  ansible.builtin.stat:
    path: "{{ breakglass_home | default('/home/' ~ breakglass_username) }}"
  register: breakglass_home_check
  when: breakglass_user_check.getent is defined and breakglass_user_check.getent != {}

- name: Record home directory check
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'checks': compliance_results.checks | combine({
            'home_exists': {
              'passed': breakglass_home_check.stat.exists | default(false),
              'message': 'Home directory exists' if breakglass_home_check.stat.exists | default(false) else 'Home directory missing'
            }
          })
        })
      }}
  when: breakglass_home_check is defined

# Check 5: Account lock status
- name: Check if account is locked
  ansible.builtin.shell: "passwd -S {{ breakglass_username }} 2>/dev/null | awk '{print $2}'"
  register: breakglass_lock_check
  changed_when: false
  failed_when: false
  when: breakglass_user_check.getent is defined and breakglass_user_check.getent != {}

- name: Record account lock check
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'checks': compliance_results.checks | combine({
            'account_not_locked': {
              'passed': breakglass_lock_check.stdout in ['P', 'PS'],
              'status': breakglass_lock_check.stdout,
              'message': 'Account is active' if breakglass_lock_check.stdout in ['P', 'PS'] else 'Account is locked or has no password'
            }
          })
        })
      }}
  when: breakglass_lock_check.stdout is defined

# Check 6: Password expiration
- name: Check password expiration
  ansible.builtin.shell: "chage -l {{ breakglass_username }} 2>/dev/null | grep 'Password expires' | cut -d: -f2 | xargs"
  register: breakglass_expiry_check
  changed_when: false
  failed_when: false
  when: breakglass_user_check.getent is defined and breakglass_user_check.getent != {}

- name: Record password expiration check
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'checks': compliance_results.checks | combine({
            'password_not_expired': {
              'passed': breakglass_expiry_check.stdout in ['never', ''],
              'expiry_date': breakglass_expiry_check.stdout,
              'message': 'Password never expires' if breakglass_expiry_check.stdout in ['never', ''] else 'Password expires on ' ~ breakglass_expiry_check.stdout
            }
          })
        })
      }}
  when: breakglass_expiry_check.stdout is defined

# Check 7: SSH key configuration
- name: Check for authorized_keys file
  ansible.builtin.stat:
    path: "{{ breakglass_home | default('/home/' ~ breakglass_username) }}/.ssh/authorized_keys"
  register: breakglass_ssh_check
  when:
    - breakglass_ssh_key_required | default(true)
    - breakglass_user_check.getent is defined and breakglass_user_check.getent != {}

- name: Get authorized_keys content if exists
  ansible.builtin.shell: "wc -l < {{ breakglass_home | default('/home/' ~ breakglass_username) }}/.ssh/authorized_keys 2>/dev/null || echo 0"
  register: breakglass_ssh_keys_count
  changed_when: false
  failed_when: false
  when:
    - breakglass_ssh_key_required | default(true)
    - breakglass_ssh_check.stat.exists | default(false)

- name: Record SSH key check
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'checks': compliance_results.checks | combine({
            'ssh_key_configured': {
              'passed': (breakglass_ssh_check.stat.exists | default(false)) and ((breakglass_ssh_keys_count.stdout | default('0')) | int > 0),
              'keys_count': (breakglass_ssh_keys_count.stdout | default('0')) | int,
              'message': 'SSH authorized keys configured (' ~ ((breakglass_ssh_keys_count.stdout | default('0')) | int) ~ ' keys)' if (breakglass_ssh_check.stat.exists | default(false)) and ((breakglass_ssh_keys_count.stdout | default('0')) | int > 0) else 'No SSH authorized keys found'
            }
          })
        })
      }}
  when: breakglass_ssh_key_required | default(true)

# Calculate overall compliance
- name: Calculate overall compliance status
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'compliant': compliance_results.checks | dict2items | map(attribute='value.passed') | map('default', true) | list | select('equalto', false) | list | length == 0
        })
      }}

# Generate summary
- name: Generate compliance summary
  ansible.builtin.set_fact:
    compliance_results: >-
      {{
        compliance_results | combine({
          'summary': compliance_results.checks | dict2items | selectattr('value.passed', 'equalto', false) | map(attribute='value.message') | list
        })
      }}

# Display results
- name: Display compliance status
  ansible.builtin.debug:
    msg: |
      ========================================
      BREAK-GLASS COMPLIANCE CHECK RESULTS
      ========================================
      Host: {{ inventory_hostname }}
      Status: {{ 'COMPLIANT' if compliance_results.compliant else 'NON-COMPLIANT' }}
      Timestamp: {{ compliance_results.timestamp }}
      ----------------------------------------
      {% for check_name, check_result in compliance_results.checks.items() %}
      [{{ 'PASS' if check_result.passed else 'FAIL' }}] {{ check_result.message }}
      {% endfor %}
      ========================================

- name: Fail if non-compliant and strict mode enabled
  ansible.builtin.fail:
    msg: "Host {{ inventory_hostname }} is NON-COMPLIANT: {{ compliance_results.summary | join(', ') }}"
  when:
    - not compliance_results.compliant
    - strict_compliance_mode | default(false)
