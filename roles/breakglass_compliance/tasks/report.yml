---
# Break-Glass Compliance Report Generation Tasks

- name: Ensure compliance check has been run
  ansible.builtin.set_fact:
    compliance_results: "{{ compliance_results | default({'error': 'No compliance check data available'}) }}"

- name: Create report directory on controller
  ansible.builtin.file:
    path: "{{ compliance_report_path | dirname }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true
  become: false

- name: Initialize aggregated report
  ansible.builtin.set_fact:
    aggregated_report:
      report_timestamp: "{{ ansible_date_time.iso8601 }}"
      total_hosts: "{{ ansible_play_hosts | length }}"
      compliant_hosts: []
      non_compliant_hosts: []
      hosts_details: []
  run_once: true
  delegate_to: localhost

- name: Aggregate compliance results from all hosts
  ansible.builtin.set_fact:
    aggregated_report: >-
      {{
        aggregated_report | combine({
          'compliant_hosts': aggregated_report.compliant_hosts + ([inventory_hostname] if compliance_results.compliant | default(false) else []),
          'non_compliant_hosts': aggregated_report.non_compliant_hosts + ([] if compliance_results.compliant | default(false) else [inventory_hostname]),
          'hosts_details': aggregated_report.hosts_details + [compliance_results]
        })
      }}
  delegate_to: localhost

- name: Calculate compliance statistics
  ansible.builtin.set_fact:
    aggregated_report: >-
      {{
        aggregated_report | combine({
          'statistics': {
            'compliant_count': aggregated_report.compliant_hosts | length,
            'non_compliant_count': aggregated_report.non_compliant_hosts | length,
            'compliance_percentage': ((aggregated_report.compliant_hosts | length) / (ansible_play_hosts | length) * 100) | round(2)
          }
        })
      }}
  run_once: true
  delegate_to: localhost

# Generate JSON Report
- name: Write JSON compliance report
  ansible.builtin.copy:
    content: "{{ aggregated_report | to_nice_json }}"
    dest: "{{ compliance_report_path }}"
    mode: "0644"
  delegate_to: localhost
  run_once: true
  become: false
  when: compliance_report_format == 'json'

# Generate HTML Report
- name: Write HTML compliance report
  ansible.builtin.copy:
    content: |
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Break-Glass Compliance Report</title>
          <style>
              body {
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                  margin: 0;
                  padding: 20px;
                  background-color: #1a1a2e;
                  color: #eaeaea;
              }
              .container {
                  max-width: 1200px;
                  margin: 0 auto;
              }
              h1 {
                  color: #00d4ff;
                  border-bottom: 2px solid #00d4ff;
                  padding-bottom: 10px;
              }
              .summary-cards {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 20px;
                  margin: 20px 0;
              }
              .card {
                  background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
                  padding: 20px;
                  border-radius: 10px;
                  text-align: center;
                  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
              }
              .card h2 {
                  margin: 0;
                  font-size: 2.5em;
              }
              .card.compliant h2 { color: #00ff88; }
              .card.non-compliant h2 { color: #ff4757; }
              .card.total h2 { color: #00d4ff; }
              .card p {
                  margin: 10px 0 0 0;
                  color: #a0a0a0;
              }
              .host-table {
                  width: 100%;
                  border-collapse: collapse;
                  margin-top: 20px;
              }
              .host-table th, .host-table td {
                  padding: 12px;
                  text-align: left;
                  border-bottom: 1px solid #333;
              }
              .host-table th {
                  background-color: #0f3460;
                  color: #00d4ff;
              }
              .host-table tr:hover {
                  background-color: #16213e;
              }
              .status-pass {
                  color: #00ff88;
                  font-weight: bold;
              }
              .status-fail {
                  color: #ff4757;
                  font-weight: bold;
              }
              .timestamp {
                  color: #666;
                  font-size: 0.9em;
                  margin-top: 20px;
              }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>üîê Break-Glass Compliance Report</h1>
              
              <div class="summary-cards">
                  <div class="card total">
                      <h2>{{ aggregated_report.total_hosts }}</h2>
                      <p>Total Hosts</p>
                  </div>
                  <div class="card compliant">
                      <h2>{{ aggregated_report.statistics.compliant_count }}</h2>
                      <p>Compliant</p>
                  </div>
                  <div class="card non-compliant">
                      <h2>{{ aggregated_report.statistics.non_compliant_count }}</h2>
                      <p>Non-Compliant</p>
                  </div>
                  <div class="card total">
                      <h2>{{ aggregated_report.statistics.compliance_percentage }}%</h2>
                      <p>Compliance Rate</p>
                  </div>
              </div>
              
              <h2>Host Details</h2>
              <table class="host-table">
                  <thead>
                      <tr>
                          <th>Hostname</th>
                          <th>Status</th>
                          <th>Account Exists</th>
                          <th>UID Valid</th>
                          <th>Shell Valid</th>
                          <th>SSH Keys</th>
                          <th>Not Locked</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for host in aggregated_report.hosts_details %}
                      <tr>
                          <td>{{ host.hostname }}</td>
                          <td class="{{ 'status-pass' if host.compliant else 'status-fail' }}">
                              {{ 'COMPLIANT' if host.compliant else 'NON-COMPLIANT' }}
                          </td>
                          <td class="{{ 'status-pass' if host.checks.account_exists.passed | default(false) else 'status-fail' }}">
                              {{ '‚úì' if host.checks.account_exists.passed | default(false) else '‚úó' }}
                          </td>
                          <td class="{{ 'status-pass' if host.checks.uid_valid.passed | default(false) else 'status-fail' }}">
                              {{ '‚úì' if host.checks.uid_valid.passed | default(false) else '‚úó' }}
                          </td>
                          <td class="{{ 'status-pass' if host.checks.shell_valid.passed | default(false) else 'status-fail' }}">
                              {{ '‚úì' if host.checks.shell_valid.passed | default(false) else '‚úó' }}
                          </td>
                          <td class="{{ 'status-pass' if host.checks.ssh_key_configured.passed | default(false) else 'status-fail' }}">
                              {{ '‚úì' if host.checks.ssh_key_configured.passed | default(false) else '‚úó' }}
                          </td>
                          <td class="{{ 'status-pass' if host.checks.account_not_locked.passed | default(false) else 'status-fail' }}">
                              {{ '‚úì' if host.checks.account_not_locked.passed | default(false) else '‚úó' }}
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
              
              <p class="timestamp">Report generated: {{ aggregated_report.report_timestamp }}</p>
          </div>
      </body>
      </html>
    dest: "{{ compliance_report_path | regex_replace('\\.json$', '.html') }}"
    mode: "0644"
  delegate_to: localhost
  run_once: true
  become: false
  when: compliance_report_format == 'html'

- name: Display report summary
  ansible.builtin.debug:
    msg: |
      ========================================
      COMPLIANCE REPORT GENERATED
      ========================================
      Total Hosts: {{ aggregated_report.total_hosts }}
      Compliant: {{ aggregated_report.statistics.compliant_count }}
      Non-Compliant: {{ aggregated_report.statistics.non_compliant_count }}
      Compliance Rate: {{ aggregated_report.statistics.compliance_percentage }}%
      ----------------------------------------
      Report saved to: {{ compliance_report_path }}
      ========================================
  run_once: true
  delegate_to: localhost



