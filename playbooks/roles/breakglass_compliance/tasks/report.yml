---
- name: Skip report if disabled
  ansible.builtin.meta: end_task
  when: not generate_report | bool

- name: Ensure report directory exists
  ansible.builtin.file:
    path: "{{ compliance_report_path | dirname }}"
    state: directory
    mode: "0755"

- name: Write compliance report (JSON)
  ansible.builtin.copy:
    dest: "{{ compliance_report_path }}"
    content: "{{ compliance | to_nice_json }}"
    mode: "0644"
  when: compliance_report_format == "json"

- name: Display compliance summary
  ansible.builtin.debug:
    msg:
      host: "{{ compliance.host }}"
      compliant: "{{ compliance.compliant }}"
      failed_checks: >-
        {{
          compliance.checks
          | dict2items
          | selectattr('value.passed', 'equalto', false)
          | map(attribute='key')
          | list
        }}
