---
- name: Initialize compliance report structure
  ansible.builtin.set_fact:
    breakglass_compliance_report:
      host: "{{ inventory_hostname }}"
      user: "{{ breakglass_username }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      checks: {}
  when: generate_report | default(true)

- name: Populate compliance report
  ansible.builtin.set_fact:
    breakglass_compliance_report: >-
      {{
        breakglass_compliance_report
        | combine(
            {
              'checks': breakglass_checks | default({})
            },
            recursive=True
          )
      }}
  when: generate_report | default(true)

- name: Write compliance report to file
  ansible.builtin.copy:
    dest: "{{ compliance_report_path }}"
    content: "{{ breakglass_compliance_report | to_nice_json }}"
    mode: "0644"
  when:
    - generate_report | default(true)
    - compliance_report_format | default('json') == 'json'
